<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Dashboard de Estatísticas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Importar Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .kpi-card {
      border-left: 5px solid;
    }
    .kpi-card.border-primary { border-color: #0d6efd; }
    .kpi-card.border-warning { border-color: #ffc107; }
    .kpi-card.border-success { border-color: #198754; }
    .kpi-card.border-danger { border-color: #dc3545; }
  </style>
</head>
<body>
<div th:replace="~{fragments :: thenavbar}"></div>

<div class="container-fluid mt-4">
  <h2 class="mb-3">Dashboard de Estatísticas</h2>

  <!-- Filtros -->
  <div class="card mb-4">
    <div class="card-body">
      <form th:action="@{/estatisticas}" method="get" class="row g-3 align-items-end">
        <div class="col-md-4">
          <label for="cidadeId" class="form-label">Ranking por Cidade</label>
          <select id="cidadeId" name="cidadeId" class="form-select">
            <option th:each="cidade : ${cidades}"
                    th:value="${cidade.idCidade}"
                    th:text="${cidade.nome}"
                    th:selected="${cidade.idCidade == cidadeIdSelecionada}"></option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="dataInicio" class="form-label">Data de Início (Impacto)</label>
          <input type="date" id="dataInicio" name="dataInicio" class="form-control" th:value="${#temporals.format(dataInicioSelecionada, 'yyyy-MM-dd')}">
        </div>
        <div class="col-md-3">
          <label for="dataFim" class="form-label">Data Final (Impacto)</label>
          <input type="date" id="dataFim" name="dataFim" class="form-control" th:value="${#temporals.format(dataFimSelecionada, 'yyyy-MM-dd')}">
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary w-100">Filtrar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card shadow-sm kpi-card border-warning">
        <div class="card-body">
          <h5 class="card-title text-warning text-uppercase">Atividades Pendentes</h5>
          <p class="card-text fs-2 fw-bold" th:text="${estatisticas.atividadesPendentes}"></p>
          <small class="text-muted">Agendamentos sem feedback registrado.</small>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm kpi-card border-success">
        <div class="card-body">
          <h5 class="card-title text-success text-uppercase">Público Alcançado</h5>
          <p class="card-text fs-2 fw-bold" th:text="${estatisticas.impacto.publicoTotal}"></p>
          <small class="text-muted" th:text="'No período de ' + ${#temporals.format(dataInicioSelecionada, 'dd/MM/yy')} + ' a ' + ${#temporals.format(dataFimSelecionada, 'dd/MM/yy')}"></small>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm kpi-card border-danger">
        <div class="card-body">
          <h5 class="card-title text-danger text-uppercase">Custos Totais</h5>
          <p class="card-text fs-2 fw-bold" th:text="'R$ ' + ${#numbers.formatDecimal(estatisticas.impacto.custoTotal, 1, 'POINT', 2, 'COMMA')}"></p>
          <small class="text-muted" th:text="'No período de ' + ${#temporals.format(dataInicioSelecionada, 'dd/MM/yy')} + ' a ' + ${#temporals.format(dataFimSelecionada, 'dd/MM/yy')}"></small>
        </div>
      </div>
    </div>
  </div>

  <!-- Ranking e Gráfico -->
  <div class="row">
    <div class="col-md-7">
      <div class="card shadow-sm">
        <div class="card-header">
          Top 10 Usuários por Pontuação
        </div>
        <div class="card-body">
          <canvas id="rankingChart"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-5">
      <div class="card shadow-sm">
        <div class="card-header">
          Detalhes do Ranking
        </div>
        <div class="card-body">
          <table class="table table-striped">
            <thead>
            <tr>
              <th>#</th>
              <th>Nome</th>
              <th>Função</th>
              <th>Pontos</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="user, iterStat : ${estatisticas.ranking}">
              <td th:text="${iterStat.count}"></td>
              <td th:text="${user.nome}"></td>
              <td th:text="${user.funcao}"></td>
              <td th:text="${user.pontuacao}"></td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script th:inline="javascript">
  /*<![CDATA[*/
  const labels = /*[[${estatisticas.rankingLabels}]]*/ [];
  const data = /*[[${estatisticas.rankingData}]]*/ [];

  const ctx = document.getElementById('rankingChart').getContext('2d');
  const rankingChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Pontuação',
        data: data,
        backgroundColor: 'rgba(54, 162, 235, 0.6)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true
        }
      },
      plugins: {
        legend: {
          display: false
        }
      }
    }
  });
  /*]]>*/
</script>

</body>
</html>
